<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Top 1000 Rankers</title>
    <script>
        let refreshTimer = null;
        let previousRanks = {};
        let allPlayers = [];
        let currentPage = 1;

        // ğŸ”¹ ë””ë¹„ì „ ê³„ì‚° + ì•„ì´ì½˜ ë§¤ì¹­ (í•œê¸€ í‹°ì–´ëª…)
        function getDivisionByMMR(mmr, rank) {
            const divisions = [
                { tier: "ì•„ì´ì–¸ IV", min: 0, max: 149, icon: "1.png" },
                { tier: "ì•„ì´ì–¸ III", min: 150, max: 299, icon: "1.png" },
                { tier: "ì•„ì´ì–¸ II", min: 300, max: 449, icon: "1.png" },
                { tier: "ì•„ì´ì–¸ I", min: 450, max: 599, icon: "1.png" },

                { tier: "ë¸Œë¡ ì¦ˆ IV", min: 600, max: 799, icon: "2.png" },
                { tier: "ë¸Œë¡ ì¦ˆ III", min: 800, max: 999, icon: "2.png" },
                { tier: "ë¸Œë¡ ì¦ˆ II", min: 1000, max: 1199, icon: "2.png" },
                { tier: "ë¸Œë¡ ì¦ˆ I", min: 1200, max: 1399, icon: "2.png" },

                { tier: "ì‹¤ë²„ IV", min: 1400, max: 1649, icon: "3.png" },
                { tier: "ì‹¤ë²„ III", min: 1650, max: 1899, icon: "3.png" },
                { tier: "ì‹¤ë²„ II", min: 1900, max: 2149, icon: "3.png" },
                { tier: "ì‹¤ë²„ I", min: 2150, max: 2399, icon: "3.png" },

                { tier: "ê³¨ë“œ IV", min: 2400, max: 2699, icon: "4.png" },
                { tier: "ê³¨ë“œ III", min: 2700, max: 2999, icon: "4.png" },
                { tier: "ê³¨ë“œ II", min: 3000, max: 3299, icon: "4.png" },
                { tier: "ê³¨ë“œ I", min: 3300, max: 3599, icon: "4.png" },

                { tier: "í”Œë˜í‹°ë„˜ IV", min: 3600, max: 3949, icon: "5.png" },
                { tier: "í”Œë˜í‹°ë„˜ III", min: 3950, max: 4299, icon: "5.png" },
                { tier: "í”Œë˜í‹°ë„˜ II", min: 4300, max: 4649, icon: "5.png" },
                { tier: "í”Œë˜í‹°ë„˜ I", min: 4650, max: 4999, icon: "5.png" },

                { tier: "ë‹¤ì´ì•„ëª¬ë“œ IV", min: 5000, max: 5349, icon: "6.png" },
                { tier: "ë‹¤ì´ì•„ëª¬ë“œ III", min: 5350, max: 5699, icon: "6.png" },
                { tier: "ë‹¤ì´ì•„ëª¬ë“œ II", min: 5700, max: 6049, icon: "6.png" },
                { tier: "ë‹¤ì´ì•„ëª¬ë“œ I", min: 6050, max: 6399, icon: "6.png" },

                { tier: "ë©”í…Œì˜¤ë¼ì´íŠ¸", min: 6400, max: 7099, icon: "63.png" },
                { tier: "ë¯¸ìŠ¤ë¦´", min: 7100, max: 7799, icon: "66.png" },
            ];

            if (mmr >= 7800) {
                if (rank && rank <= 300) {
                    return { tier: "ì´í„°ë‹ˆí‹°", detail: `ì´í„°ë‹ˆí‹° - ${mmr - 7800} RP`, icon: "8.png" };
                }
                if (rank && rank <= 1000) {
                    return { tier: "ë°ë¯¸ê°“", detail: `ë°ë¯¸ê°“ - ${mmr - 7800} RP`, icon: "7.png" };
                }
                return { tier: "ë¯¸ìŠ¤ë¦´+", detail: `ë¯¸ìŠ¤ë¦´ - ${mmr - 7100} RP`, icon: "66.png" };
            }

            for (const div of divisions) {
                if (mmr >= div.min && mmr <= div.max) {
                    return {
                        tier: div.tier,
                        detail: `${div.tier} - ${mmr - div.min} RP`,
                        icon: div.icon
                    };
                }
            }

            return { tier: "ì–¸ë­í¬", detail: "", icon: "1.png" };
        }

        // ğŸ”¹ API í˜¸ì¶œ
        async function loadTop1000() {
            try {
                const server = document.getElementById("serverSelect").value;
                const mode = document.getElementById("modeSelect").value;

                const url = `/api/top1000?mode=${mode}&server=${server}`;
                const res = await fetch(url);
                const data = await res.json();

                if (!Array.isArray(data)) {
                    document.getElementById("rankTable").innerHTML =
                        `<tr><td colspan="6">âš  ë°ì´í„° ì—†ìŒ</td></tr>`;
                    return;
                }

                allPlayers = data;
                currentPage = 1;
                renderPage();

                previousRanks = {};
                data.forEach(p => {
                    previousRanks[p.nickname] = p.rank;
                });

                document.getElementById("lastUpdate").innerText =
                    "â± ë§ˆì§€ë§‰ ê°±ì‹ : " + new Date().toLocaleTimeString();
            } catch (err) {
                console.error("ë°ì´í„° ê°±ì‹  ì‹¤íŒ¨:", err);
            }
        }

        // ğŸ”¹ í˜ì´ì§€ ë Œë”ë§
        function renderPage() {
            const tbody = document.getElementById("rankTable");
            tbody.innerHTML = "";

            const start = (currentPage - 1) * 10;
            const end = start + 10;
            const players = allPlayers.slice(start, end);

            players.forEach(player => {
                const prevRank = previousRanks[player.nickname];
                let changeSymbol = "â€“";
                let changeColor = "gray";
                let changeText = "";

                if (prevRank !== undefined) {
                    const rankDiff = prevRank - player.rank;
                    if (rankDiff > 0) {
                        changeSymbol = "â¬†ï¸"; changeColor = "green"; changeText = `(+${rankDiff})`;
                    } else if (rankDiff < 0) {
                        changeSymbol = "â¬‡ï¸"; changeColor = "red"; changeText = `(${rankDiff})`;
                    }
                }

                const division = getDivisionByMMR(player.mmr, player.rank);

                tbody.innerHTML += `
          <tr>
            <td>${player.rank}</td>
            <td class="nickname">${player.nickname}</td>
            <td><img src="/tiers/${division.icon}" width="40"></td>
            <td>${division.tier}<br><small>${division.detail}</small></td>
            <td>${player.mmr}</td>
            <td style="color:${changeColor}; font-weight:bold;">
              ${changeSymbol} ${changeText}
            </td>
          </tr>`;
            });

            updatePagination();
        }

        // ğŸ”¹ í˜ì´ì§€ë„¤ì´ì…˜ (í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ ì´ë™)
        function updatePagination() {
            const totalPages = Math.ceil(allPlayers.length / 10);
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";

            const first = document.createElement("button");
            first.textContent = "Â« ì²˜ìŒ";
            first.disabled = currentPage === 1;
            first.onclick = () => { currentPage = 1; renderPage(); };
            pagination.appendChild(first);

            const prev = document.createElement("button");
            prev.textContent = "â€¹ ì´ì „";
            prev.disabled = currentPage === 1;
            prev.onclick = () => { currentPage--; renderPage(); };
            pagination.appendChild(prev);

            // í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ í˜ì´ì§€ ë²”ìœ„
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.disabled = (i === currentPage);
                btn.onclick = () => { currentPage = i; renderPage(); };
                pagination.appendChild(btn);
            }

            const next = document.createElement("button");
            next.textContent = "ë‹¤ìŒ â€º";
            next.disabled = currentPage === totalPages;
            next.onclick = () => { currentPage++; renderPage(); };
            pagination.appendChild(next);

            const last = document.createElement("button");
            last.textContent = "ë Â»";
            last.disabled = currentPage === totalPages;
            last.onclick = () => { currentPage = totalPages; renderPage(); };
            pagination.appendChild(last);
        }

        function setRefreshInterval(minutes) {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(loadTop1000, minutes * 60 * 1000);
        }

        window.onload = () => {
            loadTop1000();
            setRefreshInterval(5);
            document.getElementById("refreshSelect").addEventListener("change", (e) => {
                setRefreshInterval(parseInt(e.target.value));
            });
            document.getElementById("serverSelect").addEventListener("change", loadTop1000);
            document.getElementById("modeSelect").addEventListener("change", loadTop1000);
        };
    </script>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; }
        h1 { text-align: center; }
        table {
            margin: auto;
            border-collapse: collapse;
            width: 90%;
            background: white;
            table-layout: fixed;
        }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; word-wrap: break-word; }
        th { background: #007BFF; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        td.nickname { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #controls, #pagination, #lastUpdate { text-align: center; margin: 15px; }
        button { margin: 0 5px; padding: 5px 12px; }
        button:disabled { background: #007BFF; color: white; font-weight: bold; }
    </style>
</head>
<body>
<h1>í˜„ì¬ ì‹œì¦Œ Top 1000 ìˆœìœ„í‘œ</h1>
<div id="controls">
    <label>ì„œë²„:</label>
    <select id="serverSelect">
        <option value="global">Global</option>
        <option value="10">Asia</option>
        <option value="17">Asia2</option>
        <option value="18">Asia3</option>
        <option value="12">North America</option>
        <option value="13">Europe</option>
        <option value="14">South America</option>
    </select>

    <label>ëª¨ë“œ:</label>
    <select id="modeSelect">
        <option value="1">Solo</option>
        <option value="2">Duo</option>
        <option value="3" selected>Squad</option>
    </select>

    <label>ê°±ì‹  ì£¼ê¸°:</label>
    <select id="refreshSelect">
        <option value="1">1ë¶„</option>
        <option value="5" selected>5ë¶„</option>
        <option value="10">10ë¶„</option>
        <option value="30">30ë¶„</option>
    </select>
</div>

<table>
    <thead>
    <tr>
        <th>ìˆœìœ„</th>
        <th>ë‹‰ë„¤ì„</th>
        <th>í‹°ì–´</th>
        <th>í‹°ì–´ & RP</th>
        <th>ì ìˆ˜</th>
        <th>ë³€ë™</th>
    </tr>
    </thead>
    <tbody id="rankTable"></tbody>
</table>

<div id="pagination"></div>
<p id="lastUpdate"></p>
</body>
</html>
