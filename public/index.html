<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Top 1000 Rankers</title>
    <script>
        let refreshTimer = null;
        let previousRanks = {};
        let currentPage = 1;
        let allPlayers = [];

        // 🔹 데이터 불러오기
        async function loadTop1000() {
            try {
                const server = document.getElementById("serverSelect").value;
                const mode = document.getElementById("modeSelect").value;

                let url = `/api/top1000?mode=${mode}&server=${server}`;
                const res = await fetch(url);
                const data = await res.json();

                if (!Array.isArray(data)) {
                    console.error("Unexpected data:", data);
                    document.getElementById("rankTable").innerHTML =
                        `<tr><td colspan="5">데이터 없음</td></tr>`;
                    return;
                }

                allPlayers = data;
                currentPage = 1;
                renderPage();
            } catch (err) {
                console.error("데이터 갱신 실패:", err);
            }
        }

        // 🔹 페이지 렌더링
        function renderPage() {
            const tbody = document.getElementById("rankTable");
            tbody.innerHTML = "";

            const start = (currentPage - 1) * 10;
            const end = start + 10;
            const players = allPlayers.slice(start, end);

            players.forEach(player => {
                const prevRank = previousRanks[player.nickname];
                let changeSymbol = "–";
                let changeColor = "gray";
                let changeDiff = "";

                if (prevRank !== undefined) {
                    const diff = prevRank - player.rank;
                    if (diff > 0) {
                        changeSymbol = "⬆️";
                        changeColor = "green";
                        changeDiff = `(+${diff})`;
                    } else if (diff < 0) {
                        changeSymbol = "⬇️";
                        changeColor = "red";
                        changeDiff = `(${diff})`;
                    }
                }

                const row = `
          <tr>
            <td>${player.rank}</td>
            <td>${player.nickname}</td>
            <td>${player.mmr}</td>
            <td style="color:${changeColor}; font-weight:bold;">${changeSymbol} ${changeDiff}</td>
          </tr>`;
                tbody.innerHTML += row;

                previousRanks[player.nickname] = player.rank;
            });

            document.getElementById("lastUpdate").innerText =
                "⏱ 마지막 갱신: " + new Date().toLocaleTimeString();

            updatePagination();
        }

        // 🔹 페이지네이션 (현재 ±2 페이지만 표시)
        function updatePagination() {
            const totalPages = Math.ceil(allPlayers.length / 10);
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";

            // « 처음
            const firstBtn = document.createElement("button");
            firstBtn.textContent = "« 처음";
            firstBtn.disabled = currentPage === 1;
            firstBtn.onclick = () => { currentPage = 1; renderPage(); };
            pagination.appendChild(firstBtn);

            // ‹ 이전
            const prevBtn = document.createElement("button");
            prevBtn.textContent = "‹ 이전";
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            };
            pagination.appendChild(prevBtn);

            // 번호 버튼 (현재 ±2 페이지만)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.disabled = (i === currentPage);
                btn.onclick = () => { currentPage = i; renderPage(); };
                pagination.appendChild(btn);
            }

            // 다음 ›
            const nextBtn = document.createElement("button");
            nextBtn.textContent = "다음 ›";
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage();
                }
            };
            pagination.appendChild(nextBtn);

            // 끝 »
            const lastBtn = document.createElement("button");
            lastBtn.textContent = "끝 »";
            lastBtn.disabled = currentPage === totalPages;
            lastBtn.onclick = () => { currentPage = totalPages; renderPage(); };
            pagination.appendChild(lastBtn);
        }

        // 🔹 자동 갱신
        function setRefreshInterval(minutes) {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(loadTop1000, minutes * 60 * 1000);
            console.log(`자동 갱신 주기: ${minutes}분`);
        }

        // 초기 실행
        window.onload = () => {
            loadTop1000();
            setRefreshInterval(5);

            document.getElementById("refreshSelect").addEventListener("change", (e) => {
                const minutes = parseInt(e.target.value);
                setRefreshInterval(minutes);
            });
            document.getElementById("serverSelect").addEventListener("change", loadTop1000);
            document.getElementById("modeSelect").addEventListener("change", loadTop1000);
        };
    </script>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; padding: 20px; }
        h1 { text-align: center; }
        table { margin: auto; border-collapse: collapse; width: 80%; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #007BFF; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        #lastUpdate, #controls, #pagination { text-align: center; margin-top: 15px; }
        select, button { padding: 5px; margin: 3px; }
        button:disabled { background: #007BFF; color: white; font-weight: bold; }
    </style>
</head>
<body>
<h1>현재 시즌 Top 1000 Rankers</h1>

<div id="controls">
    <label>서버:</label>
    <select id="serverSelect">
        <option value="global" selected>Global (전체)</option>
        <option value="10">Asia 1</option>
        <option value="17">Asia 2</option>
        <option value="18">Asia 3</option>
        <option value="12">North America</option>
        <option value="13">Europe</option>
        <option value="14">South America</option>
    </select>

    <label>모드:</label>
    <select id="modeSelect">
        <option value="1">Solo</option>
        <option value="2">Duo</option>
        <option value="3" selected>Squad</option>
    </select>

    <label>갱신 주기:</label>
    <select id="refreshSelect">
        <option value="1">1분</option>
        <option value="5" selected>5분</option>
        <option value="10">10분</option>
        <option value="30">30분</option>
    </select>
</div>

<table>
    <thead>
    <tr>
        <th>Rank</th>
        <th>Nickname</th>
        <th>MMR</th>
        <th>변동</th>
    </tr>
    </thead>
    <tbody id="rankTable"></tbody>
</table>

<div id="pagination"></div>
<p id="lastUpdate"></p>
</body>
</html>
